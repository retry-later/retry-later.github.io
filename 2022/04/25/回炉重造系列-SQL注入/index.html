<!DOCTYPE html>
<html lang="zh-CN">

<head>
    <meta charset="UTF-8">
<meta name="viewport"
      content="width=device-width, initial-scale=1.0, maximum-scale=1.0, minimum-scale=1.0">
<meta http-equiv="X-UA-Compatible" content="ie=edge">

    <meta name="author" content="pm&fc">


    <meta name="subtitle" content="Blog">


    <meta name="description" content="写点所学所想">



<title>回炉重造系列-SQL注入 | Retry-later&#39;s Blog</title>



    <link rel="icon" href="/favicon.ico">




    <!-- stylesheets list from _config.yml -->
    
    <link rel="stylesheet" href="/css/style.css">
    



    <!-- scripts list from _config.yml -->
    
    <script src="/js/script.js"></script>
    
    <script src="/js/tocbot.min.js"></script>
    



    
    
        
    


<meta name="generator" content="Hexo 6.1.0"></head>

<body>
    <script>
        // this function is used to check current theme before page loaded.
        (() => {
            const currentTheme = window.localStorage && window.localStorage.getItem('theme') || '';
            const isDark = currentTheme === 'dark';
            const pagebody = document.getElementsByTagName('body')[0]
            if (isDark) {
                pagebody.classList.add('dark-theme');
                // mobile
                document.getElementById("mobile-toggle-theme").innerText = "· Dark"
            } else {
                pagebody.classList.remove('dark-theme');
                // mobile
                document.getElementById("mobile-toggle-theme").innerText = "· Light"
            }
        })();
    </script>

    <div class="wrapper">
        <header>
    <nav class="navbar">
        <div class="container">
            <div class="navbar-header header-logo"><a href="/">Retry-later&#39;s Blog</a></div>
            <div class="menu navbar-right">
                
                    <a class="menu-item" href="/archives">Posts</a>
                
                    <a class="menu-item" href="/category">Categories</a>
                
                    <a class="menu-item" href="/tag">Tags</a>
                
                    <a class="menu-item" href="/about">About</a>
                
                <input id="switch_default" type="checkbox" class="switch_default">
                <label for="switch_default" class="toggleBtn"></label>
            </div>
        </div>
    </nav>

    
    <nav class="navbar-mobile" id="nav-mobile">
        <div class="container">
            <div class="navbar-header">
                <div>
                    <a href="/">Retry-later&#39;s Blog</a><a id="mobile-toggle-theme">·&nbsp;Light</a>
                </div>
                <div class="menu-toggle" onclick="mobileBtn()">&#9776; Menu</div>
            </div>
            <div class="menu" id="mobile-menu">
                
                    <a class="menu-item" href="/archives">Posts</a>
                
                    <a class="menu-item" href="/category">Categories</a>
                
                    <a class="menu-item" href="/tag">Tags</a>
                
                    <a class="menu-item" href="/about">About</a>
                
            </div>
        </div>
    </nav>

</header>
<script>
    var mobileBtn = function f() {
        var toggleMenu = document.getElementsByClassName("menu-toggle")[0];
        var mobileMenu = document.getElementById("mobile-menu");
        if(toggleMenu.classList.contains("active")){
           toggleMenu.classList.remove("active")
            mobileMenu.classList.remove("active")
        }else{
            toggleMenu.classList.add("active")
            mobileMenu.classList.add("active")
        }
    }
</script>
            <div class="main">
                <div class="container">
    
    
        <div class="post-toc">
    <div class="tocbot-list">
    </div>
    <div class="tocbot-list-menu">
        <a class="tocbot-toc-expand" onclick="expand_toc()">Expand all</a>
        <a onclick="go_top()">Back to top</a>
        <a onclick="go_bottom()">Go to bottom</a>
    </div>
</div>

<script>
    var tocbot_timer;
    var DEPTH_MAX = 6;    // 为 6 时展开所有
    var tocbot_default_config = {
        tocSelector: '.tocbot-list',
        contentSelector: '.post-content',
        headingSelector: 'h1, h2, h3, h4, h5',
        orderedList: false,
        scrollSmooth: true,
        onClick: extend_click,
    };

    function extend_click() {
        clearTimeout(tocbot_timer);
        tocbot_timer = setTimeout(function () {
            tocbot.refresh(obj_merge(tocbot_default_config, { hasInnerContainers: true }));
        }, 420); // 这个值是由 tocbot 源码里定义的 scrollSmoothDuration 得来的
    }

    document.ready(function () {
        tocbot.init(obj_merge(tocbot_default_config, { collapseDepth: 1 }));
    });

    function expandToc() {
        var b = document.querySelector('.tocbot-toc-expand');
        var expanded = b.getAttribute('data-expanded');
        expanded ? b.removeAttribute('data-expanded') : b.setAttribute('data-expanded', true);
        tocbot.refresh(obj_merge(tocbot_default_config, { collapseDepth: expanded ? 1 : DEPTH_MAX }));
        b.innerText = expanded ? 'Expand all' : 'Collapse all';
    }

    function go_top() {
        window.scrollTo(0, 0);
    }

    function go_bottom() {
        window.scrollTo(0, document.body.scrollHeight);
    }

    function obj_merge(target, source) {
        for (var item in source) {
            if (source.hasOwnProperty(item)) {
                target[item] = source[item];
            }
        }
        return target;
    }
</script>
    

    
    <article class="post-wrap">
        <header class="post-header">
            <h1 class="post-title">回炉重造系列-SQL注入</h1>
            
                <div class="post-meta">
                    
                        Author: <a itemprop="author" rel="author" href="/">pm&fc</a>
                    

                    
                        <span class="post-time">
                        Date: <a href="#">四月 25, 2022&nbsp;&nbsp;0:02:41</a>
                        </span>
                    
                    
                        <span class="post-category">
                    Category:
                            
                                <a href="/categories/%E7%BD%91%E7%BB%9C%E5%AE%89%E5%85%A8/">网络安全</a>
                            
                        </span>
                    
                </div>
            
        </header>

        <div class="post-content">
            <h1 id="SQL注入"><a href="#SQL注入" class="headerlink" title="SQL注入"></a>SQL注入</h1><p>程序员在设计程序时忽略了对用户输入的检查，导致用户可以对预定义的sql语句进行一定程度的自定义拼接，使恶意sql语句被带入数据库进行执行，可能导致数据被窃取、更改以及网站被植入后门。前置知识：<a target="_blank" rel="noopener" href="https://www.runoob.com/mysql/mysql-tutorial.html">Mysql的增删改查</a>、<a target="_blank" rel="noopener" href="https://www.runoob.com/php/php-tutorial.html">PHP基本语法</a>、<a target="_blank" rel="noopener" href="https://www.runoob.com/java/java-tutorial.html">Java基本语法</a>。</p>
<h2 id="PHP-访问数据库（以mysql为例）"><a href="#PHP-访问数据库（以mysql为例）" class="headerlink" title="PHP 访问数据库（以mysql为例）"></a>PHP 访问数据库（以mysql为例）</h2><p>PHP访问mysql有三种方式：<a target="_blank" rel="noopener" href="https://www.php.net/manual/zh/mysql.installation.php">MySql</a>扩展、<a target="_blank" rel="noopener" href="https://www.php.net/manual/zh/book.mysqli.php">MySqli</a>扩展、<a target="_blank" rel="noopener" href="https://www.php.net/manual/zh/book.pdo.php">PDO</a>扩展。在PHP早期的版本中都使用MySql扩展连接Mysql数据库（PHP4 该扩展被编译入PHP），但是在2012年开始不再提倡使用该扩展连接Mysql，取而代之的是MySqli扩展。实际上在PHP5.5.0起该扩展就已经废弃，但是没有移除仍能使用，直到PHP7.0.0之后才被彻底移除。MySqli意为MySql增强版扩展，两者区别在于MySqli为持久化连接、面向对象，MySql为非持久化连接，面向过程。但是mysqli也支持面向过程的写法，其中函数的使用方法和mysql扩展及其相似。</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//mysql扩展连接数据库</span></span><br><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line">    <span class="variable">$dbName</span> = <span class="string">&quot;dvwa&quot;</span>;</span><br><span class="line">    <span class="variable">$dbHost</span> = <span class="string">&quot;localhost:8889&quot;</span>;</span><br><span class="line">    <span class="variable">$dbUser</span> = <span class="string">&quot;root&quot;</span>;</span><br><span class="line">    <span class="variable">$dbPassword</span> = <span class="string">&quot;root&quot;</span>;</span><br><span class="line"></span><br><span class="line">    <span class="comment">//打开mysql连接</span></span><br><span class="line">    <span class="variable">$connect</span> = <span class="title function_ invoke__">mysql_connect</span>(<span class="variable">$dbHost</span>,<span class="variable">$dbUser</span>,<span class="variable">$dbPassword</span>) <span class="keyword">or</span> (<span class="keyword">die</span>(<span class="string">&quot;数据库连接失败&quot;</span>.<span class="title function_ invoke__">mysql_error</span>()));</span><br><span class="line">    <span class="comment">//选择操作的数据库</span></span><br><span class="line">    <span class="title function_ invoke__">mysql_select_db</span>(<span class="variable">$dbName</span>);</span><br><span class="line">    <span class="variable">$id</span> = <span class="variable">$_GET</span>[<span class="string">&#x27;id&#x27;</span>];</span><br><span class="line">    <span class="keyword">if</span>(<span class="keyword">isset</span>(<span class="variable">$id</span>))&#123;</span><br><span class="line">        <span class="comment">//拼接查询语句</span></span><br><span class="line">        <span class="variable">$sql</span> = <span class="string">&quot;select * from `users` where `user_id`=&quot;</span>.<span class="variable">$id</span>.<span class="string">&quot;;&quot;</span>;</span><br><span class="line">        <span class="comment">//执行sql语句</span></span><br><span class="line">        <span class="variable">$result</span> = <span class="title function_ invoke__">mysql_query</span>(<span class="variable">$sql</span>);</span><br><span class="line">        <span class="keyword">if</span>(<span class="variable">$result</span>)&#123;</span><br><span class="line">            <span class="comment">//如果有结果，迭代每行结果中的user字段并输出</span></span><br><span class="line">            <span class="keyword">while</span>(<span class="variable">$i</span> = <span class="title function_ invoke__">mysql_fetch_array</span>(<span class="variable">$result</span>))&#123;</span><br><span class="line">                <span class="keyword">echo</span> <span class="variable">$i</span>[<span class="string">&#x27;user&#x27;</span>];</span><br><span class="line">                <span class="keyword">echo</span> <span class="string">&quot;&lt;br/&gt;&quot;</span>;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;<span class="keyword">else</span>&#123;</span><br><span class="line">            <span class="keyword">echo</span> <span class="title function_ invoke__">mysql_error</span>();</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;<span class="keyword">else</span>&#123;</span><br><span class="line">        <span class="keyword">echo</span> <span class="string">&quot;id 不能为空！&quot;</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">//关闭mysql连接</span></span><br><span class="line">    <span class="title function_ invoke__">mysql_close</span>(<span class="variable">$connect</span>);</span><br></pre></td></tr></table></figure>

<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//mysqli扩展连接数据库（面向连接的写法，与mysql扩展使用方法相似）</span></span><br><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line">    <span class="variable">$dbName</span> = <span class="string">&quot;dvwa&quot;</span>;</span><br><span class="line">    <span class="variable">$dbHost</span> = <span class="string">&quot;localhost:8889&quot;</span>;</span><br><span class="line">    <span class="variable">$dbUser</span> = <span class="string">&quot;root&quot;</span>;</span><br><span class="line">    <span class="variable">$dbPassword</span> = <span class="string">&quot;root&quot;</span>;</span><br><span class="line"></span><br><span class="line">    <span class="comment">//创建数据库连接</span></span><br><span class="line">    <span class="variable">$connect</span> = <span class="title function_ invoke__">mysqli_connect</span>(<span class="variable">$dbHost</span>,<span class="variable">$dbUser</span>,<span class="variable">$dbPassword</span>) <span class="keyword">or</span> (<span class="keyword">die</span>(<span class="string">&quot;数据库连接失败！&lt;br/&gt;&quot;</span>.<span class="title function_ invoke__">mysqli_error</span>(<span class="variable">$connect</span>)));</span><br><span class="line">    <span class="comment">//选择数据库 注意mysqli和mysql两个扩展中的相似函数有不同，mysql_select_db()可以不用传入数据库连接变量，但是mysqli的函数必须填入。</span></span><br><span class="line">    <span class="title function_ invoke__">mysqli_select_db</span>(<span class="variable">$connect</span>,<span class="variable">$dbName</span>);</span><br><span class="line">    <span class="variable">$id</span> = <span class="variable">$_GET</span>[<span class="string">&quot;id&quot;</span>];</span><br><span class="line">    <span class="keyword">if</span>(<span class="keyword">isset</span>(<span class="variable">$id</span>))&#123;</span><br><span class="line">        <span class="comment">//拼接查询语句</span></span><br><span class="line">        <span class="variable">$sql</span> = <span class="string">&quot;select * from `users` where `user_id`=&quot;</span>.<span class="variable">$id</span>.<span class="string">&quot;;&quot;</span>;</span><br><span class="line">        <span class="comment">//执行数据库语句</span></span><br><span class="line">        <span class="variable">$result</span> = <span class="title function_ invoke__">mysqli_query</span>(<span class="variable">$connect</span>,<span class="variable">$sql</span>);</span><br><span class="line">        <span class="keyword">if</span>(<span class="variable">$result</span>)&#123;</span><br><span class="line">            <span class="comment">//如果有结果，迭代每行结果中的user字段并输出</span></span><br><span class="line">            <span class="keyword">while</span>(<span class="variable">$i</span> = <span class="title function_ invoke__">mysqli_fetch_array</span>(<span class="variable">$result</span>))&#123;</span><br><span class="line">                <span class="keyword">echo</span> <span class="variable">$i</span>[<span class="string">&#x27;user&#x27;</span>];</span><br><span class="line">                <span class="keyword">echo</span> <span class="string">&quot;&lt;br/&gt;&quot;</span>;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;<span class="keyword">else</span>&#123;</span><br><span class="line">            <span class="keyword">echo</span> <span class="title function_ invoke__">mysqli_error</span>(<span class="variable">$connect</span>);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;<span class="keyword">else</span>&#123;</span><br><span class="line">        <span class="keyword">echo</span> <span class="string">&quot;id不能为空!&quot;</span>;</span><br><span class="line">    &#125;</span><br><span class="line"><span class="comment">//关闭数据库连接</span></span><br><span class="line"><span class="title function_ invoke__">mysqli_close</span>(<span class="variable">$connect</span>);</span><br></pre></td></tr></table></figure>

<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//mysqli扩展面向对象的写法</span></span><br><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line">    <span class="variable">$dbName</span> = <span class="string">&quot;dvwa&quot;</span>;</span><br><span class="line">    <span class="variable">$dbHost</span> = <span class="string">&quot;localhost:8889&quot;</span>;</span><br><span class="line">    <span class="variable">$dbUser</span> = <span class="string">&quot;root&quot;</span>;</span><br><span class="line">    <span class="variable">$dbPassword</span> = <span class="string">&quot;root&quot;</span>;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/*</span></span><br><span class="line"><span class="comment">     * 有个容易让人迷惑的地方，connect_error属性代表的是数据库连接的错误信息，如果数据库正确连接其值为NULL。</span></span><br><span class="line"><span class="comment">     * 用来判断在mysqli对象初始化时数据库是否正确连接。</span></span><br><span class="line"><span class="comment">     * 而error属性代表的是sql语句报错信息。</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line"></span><br><span class="line">    <span class="comment">//初始化mysqli对象</span></span><br><span class="line">    <span class="variable">$connect</span> = <span class="keyword">new</span> <span class="title function_ invoke__">mysqli</span>(<span class="variable">$dbHost</span>,<span class="variable">$dbUser</span>,<span class="variable">$dbPassword</span>);</span><br><span class="line">    <span class="comment">//检测数据库连接是否建立成功</span></span><br><span class="line">    <span class="keyword">if</span>(<span class="variable">$connect</span>-&gt;connect_error)&#123;</span><br><span class="line">        <span class="keyword">die</span>(<span class="string">&quot;数据库连接失败！&lt;br/&gt;&quot;</span>.<span class="variable">$connect</span>-&gt;connect_error);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">//调用mysqli对象中的方法指定要操作的数据库</span></span><br><span class="line">    <span class="variable">$connect</span>-&gt;<span class="title function_ invoke__">select_db</span>(<span class="variable">$dbName</span>);</span><br><span class="line"></span><br><span class="line">    <span class="variable">$id</span> = <span class="variable">$_GET</span>[<span class="string">&quot;id&quot;</span>];</span><br><span class="line">    <span class="keyword">if</span>(<span class="keyword">isset</span>(<span class="variable">$id</span>))&#123;</span><br><span class="line">        <span class="comment">//拼接查询语句</span></span><br><span class="line">        <span class="variable">$sql</span> = <span class="string">&quot;select * from `users` where `user_id`=&quot;</span>.<span class="variable">$id</span>.<span class="string">&quot;;&quot;</span>;</span><br><span class="line">        <span class="comment">//执行数据库语句</span></span><br><span class="line">        <span class="variable">$result</span> = <span class="variable">$connect</span>-&gt;<span class="title function_ invoke__">query</span>(<span class="variable">$sql</span>);</span><br><span class="line">        <span class="keyword">if</span>(<span class="variable">$result</span>)&#123;</span><br><span class="line">            <span class="keyword">if</span>(<span class="variable">$result</span>-&gt;num_rows &gt; <span class="number">0</span>)&#123;</span><br><span class="line">                <span class="keyword">while</span>(<span class="variable">$i</span> = <span class="variable">$result</span>-&gt;<span class="title function_ invoke__">fetch_array</span>())&#123;</span><br><span class="line">                    <span class="keyword">echo</span> <span class="variable">$i</span>[<span class="string">&#x27;user&#x27;</span>];</span><br><span class="line">                    <span class="keyword">echo</span> <span class="string">&quot;&lt;br/&gt;&quot;</span>;</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;<span class="keyword">else</span>&#123;</span><br><span class="line">            <span class="keyword">echo</span> <span class="variable">$connect</span>-&gt;error;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;<span class="keyword">else</span>&#123;</span><br><span class="line">        <span class="keyword">echo</span> <span class="string">&quot;id不能为空！&quot;</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">//关闭数据库连接</span></span><br><span class="line">    <span class="variable">$connect</span>-&gt;<span class="title function_ invoke__">close</span>();</span><br></pre></td></tr></table></figure>

<p>PDO名为PHP数据对象，为PHP访问数据库定一个一个轻量级的一直接口。实现PDO接口的每个数据库驱动都可以公开具体数据库的特性作为标准功能。注意利用PDO扩展自身并不能够实现任何数据库功能；必须使用一个具体的数据库PDO驱动来访问数据库服务（比如Mysql PDO、SQLite PDO）。PDO只是提供了一个数据库的抽象访问层，意味着不同数据库可以之间可以使用相同的方法进行查询和获取数据，避免了每次后端更改数据库种类之后需要重构代码的情况。PDO的最大好处在于在数据库的查询过程中出现问题可以使用异常类来处理问题，当try代码块中出现异常时，会跳到指定的catch执行代码。PDO提供了三种方法来执行sql语句，exec()方法、query()方法以及预处理语句perpare()和execute()方法。</p>
<p>exec方法主要是用来执行insert、update、delete这种不需要返回结果的语句，方法成功执行后将返回受影响的行数。</p>
<p>query方法用来执行有返回结果的select查询，方法执行成功之后返回一个PDOStatement对象，其中改对象的rowCount()方法用来获取返回的行数。</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line">    <span class="variable">$dbName</span> = <span class="string">&quot;dvwa&quot;</span>;</span><br><span class="line">    <span class="variable">$dbHost</span> = <span class="string">&quot;localhost:8889&quot;</span>;</span><br><span class="line">    <span class="variable">$dbUser</span> = <span class="string">&quot;root&quot;</span>;</span><br><span class="line">    <span class="variable">$dbPassword</span> = <span class="string">&quot;root&quot;</span>;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">try</span>&#123;</span><br><span class="line">        <span class="comment">//定义数据源（DSN）其中包含了数据库驱动名称，紧跟:后为驱动程序的可选参数，如主机名、端口、数据库名。</span></span><br><span class="line">        <span class="variable">$dsn</span> = <span class="string">&quot;mysql:host=localhost;port=8889;dbname=dvwa;charset=utf8&quot;</span>;</span><br><span class="line">        <span class="variable">$connect</span> = <span class="keyword">new</span> <span class="title function_ invoke__">PDO</span>(<span class="variable">$dsn</span>,<span class="variable">$dbUser</span>,<span class="variable">$dbPassword</span>);</span><br><span class="line">        <span class="comment">//设置错误模式，常量含义可查看PHP官方说明 php.net/manual/zh/pdo.constants.php</span></span><br><span class="line">        <span class="variable">$connect</span>-&gt;<span class="title function_ invoke__">setAttribute</span>(PDO::<span class="variable constant_">ATTR_ERRMODE</span>, PDO::<span class="variable constant_">ERRMODE_EXCEPTION</span>);</span><br><span class="line">        <span class="keyword">if</span>(<span class="keyword">isset</span>(<span class="variable">$_GET</span>[<span class="string">&#x27;id&#x27;</span>]))&#123;</span><br><span class="line">            <span class="variable">$id</span> = <span class="variable">$_GET</span>[<span class="string">&#x27;id&#x27;</span>];</span><br><span class="line">            <span class="comment">//拼接查询语句</span></span><br><span class="line">            <span class="variable">$sql</span> = <span class="string">&quot;select * from `users` where `user_id`=&quot;</span>.<span class="variable">$id</span>.<span class="string">&quot;;&quot;</span>;</span><br><span class="line">            <span class="comment">//$connect-&gt;exec($sql) 如果执行的语句是insert create等没有结果返回的语句可以使用exec方法</span></span><br><span class="line">            <span class="variable">$result</span> = <span class="variable">$connect</span>-&gt;<span class="title function_ invoke__">query</span>(<span class="variable">$sql</span>);</span><br><span class="line">            <span class="keyword">if</span>(<span class="variable">$result</span>)&#123;</span><br><span class="line">                <span class="comment">//迭代PDOStatement对象的每条记录</span></span><br><span class="line">                <span class="keyword">foreach</span> (<span class="variable">$result</span>-&gt;<span class="title function_ invoke__">fetchAll</span>() <span class="keyword">as</span> <span class="variable">$i</span>)&#123;</span><br><span class="line">                    <span class="keyword">echo</span> <span class="variable">$i</span>[<span class="string">&#x27;user&#x27;</span>];</span><br><span class="line">                    <span class="keyword">echo</span> <span class="string">&quot;&lt;br/&gt;&quot;</span>;</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;<span class="keyword">else</span>&#123;</span><br><span class="line">            <span class="keyword">echo</span> <span class="string">&quot;&lt;pre&gt;id不能为空！&lt;/pre&gt;&quot;</span>;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="comment">//释放pdo连接，因为pdo是面向对象的，所以对象的引用不存在之后会自动调用析构方法释放连接。</span></span><br><span class="line">        <span class="variable">$connect</span> = <span class="literal">null</span>;</span><br><span class="line">    &#125;<span class="keyword">catch</span>(PDOException <span class="variable">$e</span>)</span><br><span class="line">    &#123;</span><br><span class="line">        <span class="keyword">echo</span> <span class="string">&quot;数据库连接失败：\t&quot;</span>.<span class="variable">$e</span>-&gt;<span class="title function_ invoke__">getMessage</span>();</span><br><span class="line">    &#125;</span><br></pre></td></tr></table></figure>

<h2 id="Java连接Mysql"><a href="#Java连接Mysql" class="headerlink" title="Java连接Mysql"></a>Java连接Mysql</h2><p>Java场景下的Mysql连接暂且只研究jdbc的方式，和PHP的PDO扩展相似，Java提供了一个名为JDBC的标准接口，每个数据库厂商按照这个接口来开发用于Java对自家数据库的操作的Java包。因为是统一的标准所以对不同数据库的增删改查等操作调用的方法都是一样的，从用户层面屏蔽了各家数据库的差异。</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> com.mysec._sqlInject;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> javax.servlet.*;</span><br><span class="line"><span class="keyword">import</span> javax.servlet.http.*;</span><br><span class="line"><span class="keyword">import</span> javax.servlet.annotation.*;</span><br><span class="line"><span class="keyword">import</span> java.io.*;</span><br><span class="line"><span class="keyword">import</span> java.nio.charset.StandardCharsets;</span><br><span class="line"><span class="keyword">import</span> java.sql.*;</span><br><span class="line"></span><br><span class="line"><span class="meta">@WebServlet(name = &quot;SqlDemo&quot;, value = &quot;/SqlDemo&quot;)</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">SqlDemo</span> <span class="keyword">extends</span> <span class="title class_">HttpServlet</span> &#123;</span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">protected</span> <span class="keyword">void</span> <span class="title function_">doGet</span><span class="params">(HttpServletRequest request, HttpServletResponse response)</span> <span class="keyword">throws</span> ServletException, IOException &#123;</span><br><span class="line">        <span class="type">ServletOutputStream</span> <span class="variable">out</span> <span class="operator">=</span> response.getOutputStream();</span><br><span class="line">        response.setContentType(<span class="string">&quot;text/html;charset=UTF-8&quot;</span>);</span><br><span class="line">        <span class="comment">//创建mysql的连接Url</span></span><br><span class="line">        <span class="type">String</span> <span class="variable">url</span> <span class="operator">=</span> <span class="string">&quot;jdbc:mysql://localhost:8889/dvwa?userSSL=false&amp;characterEncoding=utf8&quot;</span>;</span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            <span class="comment">//加载mysql驱动</span></span><br><span class="line">            Class.forName(<span class="string">&quot;com.mysql.cj.jdbc.Driver&quot;</span>);</span><br><span class="line">            <span class="comment">//创建一个mysql连接</span></span><br><span class="line">            <span class="type">Connection</span> <span class="variable">connection</span> <span class="operator">=</span> DriverManager.getConnection(url,<span class="string">&quot;root&quot;</span>,<span class="string">&quot;root&quot;</span>);</span><br><span class="line">            <span class="comment">//从创建的mysql连接中获取一个statement对象用来执行sql语句</span></span><br><span class="line">            <span class="type">Statement</span> <span class="variable">stmt</span> <span class="operator">=</span> connection.createStatement();</span><br><span class="line">            String id;</span><br><span class="line">            <span class="keyword">if</span>(request.getParameter(<span class="string">&quot;id&quot;</span>) != <span class="literal">null</span>)&#123;</span><br><span class="line">                <span class="comment">//拼接sql语句</span></span><br><span class="line">                id = request.getParameter(<span class="string">&quot;id&quot;</span>);</span><br><span class="line">                <span class="type">String</span> <span class="variable">sql</span> <span class="operator">=</span> <span class="string">&quot;select * from `users` where `user_id` = &quot;</span>+id+<span class="string">&quot;;&quot;</span>;</span><br><span class="line">                <span class="comment">//执行sql语句，执行结果返回一个ResulSet对象</span></span><br><span class="line">                <span class="type">ResultSet</span> <span class="variable">result</span> <span class="operator">=</span> stmt.executeQuery(sql);</span><br><span class="line">                <span class="keyword">while</span> (result.next())&#123;</span><br><span class="line">                    out.write(result.getString(<span class="string">&quot;user&quot;</span>).getBytes(StandardCharsets.UTF_8));</span><br><span class="line">                    out.write(<span class="string">&quot;&lt;br/&gt;&quot;</span>.getBytes(StandardCharsets.UTF_8));</span><br><span class="line">                &#125;</span><br><span class="line">                result.close();</span><br><span class="line">            &#125;<span class="keyword">else</span> &#123;</span><br><span class="line">                out.write(<span class="string">&quot;id不能为空！&quot;</span>.getBytes(StandardCharsets.UTF_8));</span><br><span class="line">            &#125;</span><br><span class="line">            stmt.close();</span><br><span class="line">            connection.close();</span><br><span class="line">        &#125; <span class="keyword">catch</span> (Exception e) &#123;</span><br><span class="line">            <span class="comment">//输出错误信息</span></span><br><span class="line">            <span class="type">PrintStream</span> <span class="variable">printStream</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">PrintStream</span>(out);</span><br><span class="line">            e.printStackTrace(printStream);</span><br><span class="line">            printStream.close();</span><br><span class="line">        &#125;</span><br><span class="line">        out.flush();</span><br><span class="line">        out.close();</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">protected</span> <span class="keyword">void</span> <span class="title function_">doPost</span><span class="params">(HttpServletRequest request, HttpServletResponse response)</span> <span class="keyword">throws</span> ServletException, IOException &#123;</span><br><span class="line">			<span class="built_in">this</span>.doGet(request,response);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>



<h2 id="常见注入位置"><a href="#常见注入位置" class="headerlink" title="常见注入位置"></a>常见注入位置</h2><ul>
<li>表单提交：POST请求、包括GET请求；</li>
<li>URL提交参数：GET请求；</li>
<li>Cookie参数提交</li>
<li>HTTP请求头可修改的值，比如referer、User-agent等</li>
<li>一些边缘的输入点，比如mp3文件的一些文件信息。</li>
</ul>
<h2 id="SQL注入的条件"><a href="#SQL注入的条件" class="headerlink" title="SQL注入的条件"></a>SQL注入的条件</h2><ol>
<li>参数用户可控：前端传给后端的参数内容是用户可控制的。</li>
<li>参数带入数据库查询：传入的参数拼接到SQL语句中，且带入参数库查询。</li>
</ol>
<h1 id="SQL注入流程"><a href="#SQL注入流程" class="headerlink" title="SQL注入流程"></a>SQL注入流程</h1><h2 id="判断注入点"><a href="#判断注入点" class="headerlink" title="判断注入点"></a>判断注入点</h2><p>注入点是将我们的恶意SQL语句带入数据库执行的大门，如果没有注入点，恶意的SQL语句写的再六也没法注入成功。</p>
<p>在<a href="#%E5%B8%B8%E8%A7%81%E6%B3%A8%E5%85%A5%E4%BD%8D%E7%BD%AE">常见的注入位置</a>我们可以输入 <code>%5c、单引号、双引号、负数、反斜杠、特殊字符、and、or、xor 、+1、-1</code>  观察页面展示内容是否存在变化来初步判断该位置参数是否会带入数据库。</p>
<h3 id="数字型注入"><a href="#数字型注入" class="headerlink" title="数字型注入"></a>数字型注入</h3><p>当输入的参数为整形的时候，如果存在注入漏洞可以认为是数字型注入。测试demo可在上面几个代码中任意选择。</p>
<h4 id="判断步骤："><a href="#判断步骤：" class="headerlink" title="判断步骤："></a>判断步骤：</h4><ul>
<li>加单引号，如<a target="_blank" rel="noopener" href="http://localhost/sql.php?id=1&#39;">http://localhost/sql.php?id=1&#39;</a></li>
</ul>
<p>如果仅是简单的sql语句拼接的话，拼接后的sql语句应该为 <code>select * from users where id = 1&#39;;</code>将会导致数据库抛出异常，因为它无法处理1后面的’。</p>
<p><img src="https://cdn.jsdelivr.net/gh/retry-later/img/2022/image-20220413163341378.png" alt="image-20220413163341378"></p>
<ul>
<li>加and 1&#x3D;1，如<a target="_blank" rel="noopener" href="http://localhost/sql.php?id=1">http://localhost/sql.php?id=1</a> and 1&#x3D;1</li>
</ul>
<p>拼接后的sql应为<code>select * from users where id = 1 and 1=1;</code>逻辑运算被带入数据库执行，不会发生错误与原页面相同。</p>
<p><img src="https://cdn.jsdelivr.net/gh/retry-later/img/2022/image-20220413163626999.png" alt="image-20220413163626999"></p>
<p><img src="https://cdn.jsdelivr.net/gh/retry-later/img/2022/image-20220413163653352.png" alt="image-20220413163653352"></p>
<ul>
<li>加 and 1&#x3D;2，如<a target="_blank" rel="noopener" href="http://localhost/sql.php?id=1">http://localhost/sql.php?id=1</a> and 1&#x3D;2</li>
</ul>
<p>拼接后的sql为<code>select * from users where id = 1 and 1 = 2;</code>逻辑运算被带入数据库中执行，因为<code>1=2</code>条件不成立，所以不会有数据返回。</p>
<p><img src="https://cdn.jsdelivr.net/gh/retry-later/img/2022/image-20220413164353627.png" alt="image-20220413164353627"></p>
<p><img src="https://cdn.jsdelivr.net/gh/retry-later/img/2022/image-20220413164418657.png" alt="image-20220413164418657"></p>
<p>当然还有其他的判断方法，比如?id&#x3D;2-1、?id&#x3D;-1 or 1&#x3D;1。只要能够确定用户输入通过拼接之后被作为sql语句的一部分带入到数据库中执行，且程序期待的参数类型为int就可以判断该URL存在数字型注入。</p>
<h3 id="字符型注入"><a href="#字符型注入" class="headerlink" title="字符型注入"></a>字符型注入</h3><p>但输入的参数为字符串的时候，我们把这种注入类型成为字符型注入。和数字型注入不同的是，我们在注入的时候需要考虑字符串的闭合（一般单引号闭合比较常见，但是也不是绝对的要看sql语句拼接时参数前的引号是单还是双）。测试demo如下：</p>
<figure class="highlight jsp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br></pre></td><td class="code"><pre><span class="line">&lt;%@ page language=<span class="string">&quot;java&quot;</span> contentType=<span class="string">&quot;text/html; charset=UTF-8&quot;</span> pageEncoding=<span class="string">&quot;UTF-8&quot;</span> %&gt;</span><br><span class="line">&lt;%@ <span class="type">page</span> <span class="variable">import</span> <span class="operator">=</span> <span class="string">&quot;java.sql.*&quot;</span> %&gt;</span><br><span class="line">&lt;%@ page <span class="keyword">import</span>=<span class="string">&quot;java.io.PrintWriter&quot;</span> %&gt;</span><br><span class="line">&lt;%@ page <span class="keyword">import</span>=<span class="string">&quot;java.io.StringWriter&quot;</span> %&gt;</span><br><span class="line"></span><br><span class="line">&lt;%!</span><br><span class="line">    <span class="comment">//定义数据库参数</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">final</span> <span class="type">String</span> <span class="variable">url</span> <span class="operator">=</span> <span class="string">&quot;jdbc:mysql://localhost:8889/dvwa?autoReconnect=true&amp;zeroDateTimeBehavior=round&amp;useUnicode=true&amp;characterEncoding=UTF-8&amp;useOldAliasMetadataBehavior=true&amp;useOldAliasMetadataBehavior=true&amp;useSSL=false&quot;</span>;</span><br><span class="line">    Connection <span class="title function_">getConnection</span><span class="params">()</span> <span class="keyword">throws</span> SQLException, ClassNotFoundException &#123;</span><br><span class="line">        Class.forName(<span class="string">&quot;com.mysql.cj.jdbc.Driver&quot;</span>);</span><br><span class="line">        <span class="type">Connection</span> <span class="variable">connection</span> <span class="operator">=</span> DriverManager.getConnection(url,<span class="string">&quot;root&quot;</span>,<span class="string">&quot;root&quot;</span>);</span><br><span class="line">        <span class="keyword">return</span> connection;</span><br><span class="line">    &#125;</span><br><span class="line">%&gt;</span><br><span class="line"></span><br><span class="line">&lt;%</span><br><span class="line">    <span class="keyword">if</span>(request.getParameter(<span class="string">&quot;user&quot;</span>) != <span class="literal">null</span>)&#123;</span><br><span class="line">        <span class="type">String</span> <span class="variable">user</span> <span class="operator">=</span> request.getParameter(<span class="string">&quot;user&quot;</span>);</span><br><span class="line">        <span class="comment">//拼接SQL</span></span><br><span class="line">        <span class="type">String</span> <span class="variable">sql</span> <span class="operator">=</span> <span class="string">&quot;select * from `users` where `user` = \&quot;&quot;</span> + user +<span class="string">&quot;\&quot;&quot;</span>;</span><br><span class="line">        <span class="comment">//创建连接并执行SQL</span></span><br><span class="line">        <span class="keyword">try</span>&#123;</span><br><span class="line">            <span class="type">Connection</span> <span class="variable">connection</span> <span class="operator">=</span> getConnection();</span><br><span class="line">            <span class="type">Statement</span> <span class="variable">stmt</span> <span class="operator">=</span> connection.createStatement();</span><br><span class="line">            <span class="type">ResultSet</span> <span class="variable">result</span> <span class="operator">=</span> stmt.executeQuery(sql);</span><br><span class="line">            <span class="comment">// 这里想对查询结果是否为空做一个判断，但是ResultSet对象即使没有查询结果也不为null，且Java也没有提供获取返回行数的方法。</span></span><br><span class="line">            <span class="comment">// 这里就使用笨办法来判断resulset中是否有返回结果了。</span></span><br><span class="line">            <span class="comment">// 网上也提供了如下的判断方法：</span></span><br><span class="line">            <span class="comment">/*</span></span><br><span class="line"><span class="comment">                String sqltest = &quot;select count(*) from `users` where `user` = \&quot;&quot; + user + &quot;\&quot;&quot;;</span></span><br><span class="line"><span class="comment">                ResultSet result = stmt.executeQuery(sql);</span></span><br><span class="line"><span class="comment">                if(result.getInt(1) &gt; 0 )&#123;</span></span><br><span class="line"><span class="comment">                    ........</span></span><br><span class="line"><span class="comment">                &#125;else&#123;</span></span><br><span class="line"><span class="comment">                    out.write(&quot;用户不存在&quot;);</span></span><br><span class="line"><span class="comment">                &#125;</span></span><br><span class="line"><span class="comment">             */</span></span><br><span class="line">            <span class="keyword">if</span>(result.next())&#123;</span><br><span class="line">                out.write(<span class="string">&quot;first_name: &quot;</span>+result.getString(<span class="string">&quot;first_name&quot;</span>) +<span class="string">&quot;&lt;br/&gt;&quot;</span>);</span><br><span class="line">                out.write(<span class="string">&quot;last_name: &quot;</span>+result.getString(<span class="string">&quot;last_name&quot;</span>) + <span class="string">&quot;&lt;br/&gt;&quot;</span>);</span><br><span class="line">                <span class="keyword">while</span>(result.next())&#123;</span><br><span class="line">                    out.write(<span class="string">&quot;first_name: &quot;</span>+result.getString(<span class="string">&quot;first_name&quot;</span>) +<span class="string">&quot;&lt;br/&gt;&quot;</span>);</span><br><span class="line">                    out.write(<span class="string">&quot;last_name: &quot;</span>+result.getString(<span class="string">&quot;last_name&quot;</span>) + <span class="string">&quot;&lt;br/&gt;&quot;</span>);</span><br><span class="line">                &#125;</span><br><span class="line"></span><br><span class="line">            &#125;<span class="keyword">else</span> &#123;</span><br><span class="line">                out.write(<span class="string">&quot;用户不存在！&quot;</span>);</span><br><span class="line">            &#125;</span><br><span class="line">            result.close();</span><br><span class="line">            stmt.close();</span><br><span class="line">            connection.close();</span><br><span class="line">        &#125;<span class="keyword">catch</span> (Exception e)&#123;</span><br><span class="line">            <span class="comment">//为了在web界面输出报错信息</span></span><br><span class="line">            <span class="type">StringWriter</span> <span class="variable">sWriter</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">StringWriter</span>();</span><br><span class="line">            e.printStackTrace(<span class="keyword">new</span> <span class="title class_">PrintWriter</span>(sWriter));</span><br><span class="line">            out.println(sWriter);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;<span class="keyword">else</span> &#123;</span><br><span class="line">        out.write(<span class="string">&quot;user参数不能为空！&quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line">%&gt;</span><br></pre></td></tr></table></figure>



<h4 id="判断步骤"><a href="#判断步骤" class="headerlink" title="判断步骤"></a>判断步骤</h4><ul>
<li>加单引号，如<a target="_blank" rel="noopener" href="http://localhost/sql.jsp?user=admin&#39;">http://localhost/sql.jsp?user=admin&#39;</a></li>
</ul>
<p>后端拼接后的SQL语句为<code>select * from users where user=&quot;admin&#39;&quot;;  </code> ，因为单引号被包裹在双引号中，所以’也是参数的一部分而并没有改变SQL语句构造。且名为admin’的用户在数据库中不存在，最终页面返回结果为用户不存在。</p>
<p><img src="https://cdn.jsdelivr.net/gh/retry-later/img/2022/image-20220413215047822.png" alt="image-20220413215047822"></p>
<p><img src="https://cdn.jsdelivr.net/gh/retry-later/img/2022/image-20220413215151269.png" alt="image-20220413215151269"></p>
<ul>
<li>加双引号，如<a target="_blank" rel="noopener" href="http://localhost/sql.jsp?user=admin&quot;">http://localhost/sql.jsp?user=admin&quot;</a></li>
</ul>
<p>后端拼接后的SQL语句为<code>select * from users where user=&quot;admin&quot;&quot;;</code>，当这样的SQL语句被带入数据库执行时，数据库无法识别多出的”，所以会触发数据库报错。</p>
<p><img src="https://cdn.jsdelivr.net/gh/retry-later/img/2022/image-20220413215504349.png" alt="image-20220413215504349"></p>
<ul>
<li>加运算逻辑，如<a target="_blank" rel="noopener" href="http://localhost/sql.jsp?user=admin1&quot;">http://localhost/sql.jsp?user=admin1&quot;</a> or “1”&#x3D;”1</li>
</ul>
<p>后端拼接后的SQL语句为<code>select * from users where user =&quot;admin1&quot; or &quot;1&quot; = &quot;1&quot;;</code> ，根据SQL语句的逻辑，user&#x3D;”admin1” 和 “1” &#x3D; “1” 进行短路运算，只要其中一个值为true，就算符合条件因为”1”&#x3D;”1”永远为真，所以页面将会有结果输出。</p>
<p><img src="https://cdn.jsdelivr.net/gh/retry-later/img/2022/image-20220413220705892.png" alt="image-20220413220705892"></p>
<p><img src="https://cdn.jsdelivr.net/gh/retry-later/img/2022/image-20220413220925556.png" alt="image-20220413220925556"></p>
<p>还是那句话，只要是能够判断我们的输入可以被拼接到SQL语句中带到数据库执行。且参数的数据类型为String，我们就可以称之为字符型注入。</p>
<h2 id="判断字段"><a href="#判断字段" class="headerlink" title="判断字段"></a>判断字段</h2><h3 id="order-by"><a href="#order-by" class="headerlink" title="order by"></a>order by</h3><p>当我们判断程序存在注入点时，我们还需知道程序的SQL语句查询了多少个字段，我们才能够根据字段数量判断哪些字段在页面显示从而带出我们想要的数据。判断字段数通常使用order by方法，程序的SQL查询语句一般有两种写法：<code>select * from users where user=&quot;1337&quot;;</code>或者<code>select first_name,last_name,user,password from users where user = &quot;1337&quot;; </code> 。第一种是查询了表结构中的所有字段，而第二种只查询了其中的几个字段。我们可以通过注入点构造如下SQL语句来判断程序查询的字段个数：<code>select * from users where user=&quot;1337&quot; order by 1;   </code> <code>select * from users where user=&quot;1337&quot; order by 3;</code>。根据页面返回情况来判断查询字段数，这里以字符型注入的Demo进行测试。</p>
<p>传入正常参数：URL: <a target="_blank" rel="noopener" href="http://localhost/sql.jsp?user=1337">http://localhost/sql.jsp?user=1337</a> ,经过拼接后的SQL <code>select * from users where user=&quot;1337&quot;; </code></p>
<p><img src="https://cdn.jsdelivr.net/gh/retry-later/img/2022/image-20220413224715350.png" alt="image-20220413224715350"></p>
<p>使用order by语句进行排序，判断字段数量：</p>
<p>Url : <a target="_blank" rel="noopener" href="http://localhost/sql.jsp?user=1337&quot;">http://localhost/sql.jsp?user=1337&quot;</a> order by 1 and “1” &#x3D; “1</p>
<p>拼接后的SQL为：<code>select * from users where user=&quot;1337&quot; order by 1 and &quot;1&quot;=&quot;1&quot;;</code>，因为我们在拼接完order by 1之后后面还会多出一个”，如果我们不闭合就会引起数据库的错误，无法达到我们判断字段数的目的。除了使用and “1” &#x3D; “1闭合之外还可以使用 <code>-- -</code> 对后面的SQL语句进行注释。其中<code>--</code>为Mysql的注释符，多的一个空格和横线是因为Mysql要求<code>--</code>后空一格才能起到注释作用，所以通常使用空格加任意字符的方式避免出错。<code>http://localhost/sql.jsp?user=1337&quot; order by 1 -- - </code><img src="https://cdn.jsdelivr.net/gh/retry-later/img/2022/image-20220413225620794.png" alt="image-20220413225620794">  <img src="https://cdn.jsdelivr.net/gh/retry-later/img/2022/image-20220413230052832.png"></p>
<p>当我们按照第九个字段进行排序的时候发现页面返回报错信息，所以我们可以判定程序查询的字段数为8。</p>
<p><img src="https://cdn.jsdelivr.net/gh/retry-later/img/2022/image-20220413230554996.png" alt="image-20220413230554996"></p>
<h2 id="判断显示的字段"><a href="#判断显示的字段" class="headerlink" title="判断显示的字段"></a>判断显示的字段</h2><h3 id="union-select"><a href="#union-select" class="headerlink" title="union select"></a>union select</h3><p>Mysql的Union操作符用于连接两个以上的SELECT语句的结果到一个结果的集合中，但是要求两个SELECT语句返回的字段数相同，比如<code>select user_id,first_name,last_name,user,password from users where user=&quot;admin&quot; union select 1,2,3,4,5;</code></p>
<p><img src="https://cdn.jsdelivr.net/gh/retry-later/img/2022/image-20220413231342861.png" alt="image-20220413231342861"></p>
<p>为了避免程序只对返回结果的第一行进行展示，从而影响我们对结果的判断。我们通常会传入一个不存在的值使得程序查询为空，迫使程序对我们的测试结果进行展示。比如:<code>select user_id,first_name,last_name,user,password from users where user=&quot;admin1&quot; union select 1,2,3,4,5;</code></p>
<p><img src="https://cdn.jsdelivr.net/gh/retry-later/img/2022/image-20220413231615151.png" alt="image-20220413231615151"></p>
<p><code>URL : http://localhost/sql.jsp?user=admin1&quot; union select 1,2,3,4,5,6,7,8 -- - </code>，根据界面显示结果判断，程序只会对8个字段中的第二三个字段进行展示。</p>
<p><img src="https://cdn.jsdelivr.net/gh/retry-later/img/2022/image-20220413231819349.png" alt="image-20220413231819349"></p>
<h3 id="concat-、group-concat-、concat-ws-函数的使用"><a href="#concat-、group-concat-、concat-ws-函数的使用" class="headerlink" title="concat()、group_concat()、concat_ws()函数的使用"></a>concat()、group_concat()、concat_ws()函数的使用</h3><p>如果想一次性带出多个信息，我们可以考虑使用mysql提供了这三个函数将多个字段的返回结果拼接成一个字符串进行展示。</p>
<p><img src="https://cdn.jsdelivr.net/gh/retry-later/img/2022/image-20220414105647363.png" alt="image-20220414105647363"></p>
<h2 id="判断数据库信息"><a href="#判断数据库信息" class="headerlink" title="判断数据库信息"></a>判断数据库信息</h2><h3 id="基本信息"><a href="#基本信息" class="headerlink" title="基本信息"></a>基本信息</h3><p>通常我们使用下表中的函数对数据库的信息进行判断：</p>
<table>
<thead>
<tr>
<th>作用</th>
<th>SQL语句</th>
</tr>
</thead>
<tbody><tr>
<td>判断数据库版本</td>
<td>select version()</td>
</tr>
<tr>
<td>判断当前数据库</td>
<td>select database()</td>
</tr>
<tr>
<td>判断当前登陆用户</td>
<td>select user()</td>
</tr>
</tbody></table>
<p><img src="https://cdn.jsdelivr.net/gh/retry-later/img/2022/image-20220413232448335.png" alt="image-20220413232448335"></p>
<p><img src="https://cdn.jsdelivr.net/gh/retry-later/img/2022/image-20220413232517744.png" alt="image-20220413232517744"></p>
<h3 id="根据information-schema获取库信息及表信息"><a href="#根据information-schema获取库信息及表信息" class="headerlink" title="根据information_schema获取库信息及表信息"></a>根据information_schema获取库信息及表信息</h3><p>Information_schema数据库中保存着整个数据库的信息，包括所有数据库名，表名，表结构，数据库用户信息，用户权限等，这个数据库在mysql5.0版本后出现。</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br></pre></td><td class="code"><pre><span class="line">SCHEMATA表</span><br><span class="line">---SCHEMATA表提供了所有数据库的信息。</span><br><span class="line">select schema_name from information_schema.schemata;</span><br><span class="line">列出所有数据库——效果等同于show databases;</span><br><span class="line">TABLES表</span><br><span class="line">---TABLES表提供了关于数据库中的表的信息（包括视图）。详细表述了某个表属于哪个schema，表类型，表引擎，创建时间等信息。</span><br><span class="line">select table_name from information_schema.tables;</span><br><span class="line">列出所有数据库中的表——效果等同于show tables from 数据库名;</span><br><span class="line">COLUMNS表</span><br><span class="line">---COLUMNS表提供了表中的列信息。详细表述了某张表的所有列以及每个列的信息。是show columns from schemaname.tablename的结果取之此表。</span><br><span class="line">STATISTICS表</span><br><span class="line">---STATISTICS表提供了关于表索引的信息。是show index from schemaname.tablename的结果取之此表。</span><br><span class="line">USER_PRIVILEGES表</span><br><span class="line">---USER_PRIVILEGES（用户权限）表给出了关于全程权限的信息。该信息源自mysql.user授权表。是非标准表。</span><br><span class="line">SCHEMA_PRIVILEGES表</span><br><span class="line">---SCHEMA_PRIVILEGES（方案权限）表给出了关于方案（数据库）权限的信息。该信息来自mysql.db授权表。是非标准表。</span><br><span class="line">TABLE_PRIVILEGES表</span><br><span class="line">---TABLE_PRIVILEGES（表权限）表给出了关于表权限的信息。该信息源自mysql.tables_priv授权表。是非标准表。</span><br><span class="line">COLUMN_PRIVILEGES表</span><br><span class="line">---COLUMN_PRIVILEGES（列权限）表给出了关于列权限的信息。该信息源自mysql.columns_priv授权表。是非标准表。</span><br><span class="line">CHARACTER_SETS表</span><br><span class="line">---CHARACTER_SETS（字符集）表提供了mysql实例可用字符集的信息。是SHOW CHARACTER SET结果集取之此表。</span><br><span class="line">COLLATIONS表</span><br><span class="line">---COLLATIONS表提供了关于各字符集的对照信息。</span><br><span class="line">COLLATION_CHARACTER_SET_APPLICABILITY表</span><br><span class="line">---COLLATION_CHARACTER_SET_APPLICABILITY表指明了可用于校对的字符集。这些列等效于SHOW COLLATION的前两个显示字段。</span><br><span class="line">TABLE_CONSTRAINTS表</span><br><span class="line">---TABLE_CONSTRAINTS表描述了存在约束的表。以及表的约束类型。</span><br><span class="line">KEY_COLUMN_USAGE表</span><br><span class="line">---KEY_COLUMN_USAGE表描述了具有约束的键列。</span><br><span class="line">ROUTINES表</span><br><span class="line">---ROUTINES表提供了关于存储子程序（存储程序和函数）的信息。此时，ROUTINES表不包含自定义函数（UDF）。名为“mysql.proc name”的列指明了对应于INFORMATION_SCHEMA.ROUTINES表的mysql.proc表列。</span><br><span class="line">VIEWS表</span><br><span class="line">---VIEWS表给出了关于数据库中的视图的信息。需要有show views权限，否则无法查看视图信息。</span><br><span class="line">TRIGGERS表</span><br><span class="line">---TRIGGERS表提供了关于触发程序的信息。必须有super权限才能查看该表。</span><br></pre></td></tr></table></figure>

<h3 id="TIPS"><a href="#TIPS" class="headerlink" title="TIPS"></a>TIPS</h3><p>SQL注入中三种注释的使用条件，mysql中有三种注释<code>--</code>、<code>/* */</code> 、<code>#</code>，<code>--</code>注释在使用的时候后后面必须跟空格，所以一般在注入的时候通常使用的形式为<code>-- +</code>,+可以替换为任意字符。<code>#</code>注释一般不会在URL中直接使用，因为URL中的#一般代表的是页面的锚点，所以在数据提交的时候不会传给后端，如果要使用的话一般使用url编码的#也就是<code>%23</code>；</p>
<p><img src="https://cdn.jsdelivr.net/gh/retry-later/img/2022/image-20220414122825335.png" alt="image-20220414122825335"></p>
<p><img src="https://cdn.jsdelivr.net/gh/retry-later/img/2022/image-20220414122911857.png" alt="image-20220414122911857"></p>
<p>以上两种注释方法适用于将后面的语句全部注释的需求，在SQL注入防范中可能会将传入的参数内的空格过滤，这时候我们可以使用<code>/**/</code>代替空格起到绕过作用。PHP示例代码如下：</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line">    <span class="variable">$dbName</span> = <span class="string">&quot;dvwa&quot;</span>;</span><br><span class="line">    <span class="variable">$dbHost</span> = <span class="string">&quot;localhost:8889&quot;</span>;</span><br><span class="line">    <span class="variable">$dbUser</span> = <span class="string">&quot;root&quot;</span>;</span><br><span class="line">    <span class="variable">$dbPassword</span> = <span class="string">&quot;root&quot;</span>;</span><br><span class="line"></span><br><span class="line">    <span class="comment">//打开mysql连接</span></span><br><span class="line">    <span class="variable">$connect</span> = <span class="title function_ invoke__">mysql_connect</span>(<span class="variable">$dbHost</span>,<span class="variable">$dbUser</span>,<span class="variable">$dbPassword</span>) <span class="keyword">or</span> (<span class="keyword">die</span>(<span class="string">&quot;数据库连接失败&quot;</span>.<span class="title function_ invoke__">mysql_error</span>()));</span><br><span class="line">    <span class="comment">//选择操作的数据库</span></span><br><span class="line">    <span class="title function_ invoke__">mysql_select_db</span>(<span class="variable">$dbName</span>);</span><br><span class="line">    <span class="variable">$id</span> = <span class="title function_ invoke__">str_replace</span>(<span class="string">&quot; &quot;</span>,<span class="string">&quot;&quot;</span>,<span class="variable">$_GET</span>[<span class="string">&#x27;id&#x27;</span>]);</span><br><span class="line">    <span class="keyword">if</span>(<span class="keyword">isset</span>(<span class="variable">$id</span>))&#123;</span><br><span class="line">        <span class="comment">//拼接查询语句</span></span><br><span class="line">        <span class="variable">$sql</span> = <span class="string">&quot;select * from `users` where `user_id`=&quot;</span>.<span class="variable">$id</span>.<span class="string">&quot;;&quot;</span>;</span><br><span class="line">        <span class="keyword">echo</span> <span class="string">&quot;SQL:&quot;</span>.<span class="variable">$sql</span>.<span class="string">&quot;&lt;br/&gt;&quot;</span>;</span><br><span class="line">        <span class="comment">//执行sql语句</span></span><br><span class="line">        <span class="variable">$result</span> = <span class="title function_ invoke__">mysql_query</span>(<span class="variable">$sql</span>);</span><br><span class="line">        <span class="keyword">if</span>(<span class="variable">$result</span>)&#123;</span><br><span class="line">            <span class="comment">//如果有结果，迭代每行结果中的user字段并输出</span></span><br><span class="line">            <span class="keyword">while</span>(<span class="variable">$i</span> = <span class="title function_ invoke__">mysql_fetch_array</span>(<span class="variable">$result</span>))&#123;</span><br><span class="line">                <span class="keyword">echo</span> <span class="variable">$i</span>[<span class="string">&#x27;user&#x27;</span>];</span><br><span class="line">                <span class="keyword">echo</span> <span class="string">&quot;&lt;br/&gt;&quot;</span>;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;<span class="keyword">else</span>&#123;</span><br><span class="line">            <span class="keyword">echo</span> <span class="title function_ invoke__">mysql_error</span>();</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;<span class="keyword">else</span>&#123;</span><br><span class="line">        <span class="keyword">echo</span> <span class="string">&quot;id 不能为空！&quot;</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">//关闭mysql连接</span></span><br><span class="line">    <span class="title function_ invoke__">mysql_close</span>(<span class="variable">$connect</span>);</span><br></pre></td></tr></table></figure>

<p><img src="https://cdn.jsdelivr.net/gh/retry-later/img/2022/image-20220414152627214.png" alt="image-20220414152627214"></p>
<h4 id="小结"><a href="#小结" class="headerlink" title="小结"></a>小结</h4><p>到这里SQL注入基本已经入门了，当然SQL注入的类型从不同的角度划分还有很多种，比如POST注入、GET注入、Cookie注入、盲注。但是个人认为数字型注入和字符型注入时所有注入类型的根本。</p>
<h1 id="SQL注入大致分类"><a href="#SQL注入大致分类" class="headerlink" title="SQL注入大致分类"></a>SQL注入大致分类</h1><p>SQL从不同角度有不同分类，比如按照注入点的位置可以分为：GET注入、POST注入、cookie注入、HTTP头部注入；按照执行效果来分：基于布尔的盲注、基于时间的盲注、报错注入、联合查询注入、对查询注入。</p>
<h2 id="Cookie注入"><a href="#Cookie注入" class="headerlink" title="Cookie注入"></a>Cookie注入</h2><p>这也是http头部注入的一种，这种漏洞主要出现在老的ASP网站上，在ASP的request对象获取表单数据的时候，正规写法为<code>request.form(&quot;id&quot;)</code>或者<code>request.cookies(&quot;xxx&quot;)</code>；但是ASP也支持<code>request(&quot;参数名称&quot;)</code>的简写，这样简写ASP引擎会按照Query String、Form、Cookies、ServerVariables的顺序依次在在每个对象中搜索有没有要查询的参数，而开发者在对用户输入做过滤的时候只做了form和get的QueryString的过滤的话，cookies就会成为漏网之鱼被人利用。cookies传递参数在PHP5.4版本之前是可以的，但是5.4版本之后就不行了。</p>
<p><em><strong><u>等找个CMS实际体验一下。</u></strong></em></p>
<p>Cookie注入还存在另一种情况，开发者将一些信息写到了客户端cookie中，比如用户名、登陆信息等。当用户提交数据到服务器时，服务器从cookie获取数据拼接到sql中执行。从而也就造成了cookie注入。</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line"><span class="keyword">include</span> <span class="string">&quot;../conf/db.php&quot;</span>;</span><br><span class="line"></span><br><span class="line"><span class="variable">$connect</span> = <span class="keyword">new</span> <span class="title function_ invoke__">mysqli</span>(<span class="variable">$dbHost</span>,<span class="variable">$dbUser</span>,<span class="variable">$dbPassword</span>);</span><br><span class="line"><span class="keyword">if</span>(<span class="keyword">isset</span>(<span class="variable">$_GET</span>[<span class="string">&quot;delete&quot;</span>]))&#123;</span><br><span class="line">    <span class="title function_ invoke__">setcookie</span>(<span class="string">&quot;user_id&quot;</span>,<span class="string">&quot;null&quot;</span>,<span class="title function_ invoke__">time</span>()-<span class="number">3600</span>);</span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">if</span>(<span class="variable">$connect</span>-&gt;connect_error)&#123;</span><br><span class="line">    <span class="keyword">die</span>(<span class="string">&quot;Error:&quot;</span>.<span class="variable">$connect</span>-&gt;connect_error);</span><br><span class="line">&#125;<span class="keyword">else</span>&#123;</span><br><span class="line">    <span class="variable">$connect</span>-&gt;<span class="title function_ invoke__">select_db</span>(<span class="string">&quot;dvwa&quot;</span>);</span><br><span class="line">    <span class="keyword">if</span>(<span class="keyword">isset</span>(<span class="variable">$_COOKIE</span>[<span class="string">&quot;user_id&quot;</span>]))&#123;</span><br><span class="line">        <span class="variable">$sql</span> = <span class="string">&quot;select * from `userAccessLog` where `user_id` = &#x27;&quot;</span>.<span class="variable">$_COOKIE</span>[<span class="string">&#x27;user_id&#x27;</span>].<span class="string">&quot;&#x27;;&quot;</span>;</span><br><span class="line">        <span class="keyword">echo</span> <span class="string">&quot;&lt;a href=&#x27;Cookie_inject.php?delete&#x27;&gt;删除Cookie&lt;/a&gt;&lt;br/&gt;&quot;</span>;</span><br><span class="line">        <span class="variable">$result</span> = <span class="variable">$connect</span>-&gt;<span class="title function_ invoke__">query</span>(<span class="variable">$sql</span>);</span><br><span class="line">        <span class="keyword">if</span>(<span class="variable">$result</span>-&gt;num_rows &gt; <span class="number">0</span>)&#123;</span><br><span class="line">            <span class="variable">$history</span> = <span class="variable">$result</span>-&gt;<span class="title function_ invoke__">fetch_array</span>();</span><br><span class="line">            <span class="variable">$c</span> = <span class="variable">$history</span>[<span class="string">&#x27;count&#x27;</span>];</span><br><span class="line">            <span class="variable">$updateSql</span> = <span class="string">&quot;update `userAccessLog` set `count`=&quot;</span>.(<span class="variable">$c</span>+<span class="number">1</span>).<span class="string">&quot; where user_id=&#x27;&quot;</span>.<span class="variable">$_COOKIE</span>[<span class="string">&#x27;user_id&#x27;</span>].<span class="string">&quot;&#x27;;&quot;</span>;</span><br><span class="line">            <span class="variable">$connect</span>-&gt;<span class="title function_ invoke__">query</span>(<span class="variable">$updateSql</span>);</span><br><span class="line">            <span class="keyword">echo</span> <span class="string">&quot;欢迎您再次访问&lt;br/&gt;&quot;</span>;</span><br><span class="line">            <span class="keyword">echo</span> <span class="string">&quot;您的访问次数为:&quot;</span>.<span class="variable">$c</span>.<span class="string">&quot;&lt;br/&gt;&quot;</span>;</span><br><span class="line">        &#125;<span class="keyword">else</span>&#123;</span><br><span class="line">            <span class="keyword">die</span>(<span class="string">&quot;Cookie 无记录！&quot;</span>);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;<span class="keyword">else</span>&#123;</span><br><span class="line">        <span class="variable">$user_id</span> = <span class="title function_ invoke__">md5</span>(<span class="title function_ invoke__">GetRandStr</span>(<span class="number">30</span>));</span><br><span class="line">        <span class="title function_ invoke__">setcookie</span>(<span class="string">&quot;user_id&quot;</span>,<span class="variable">$user_id</span>,<span class="title function_ invoke__">time</span>()+<span class="number">3600</span>);</span><br><span class="line">        <span class="variable">$sql</span> = <span class="string">&quot;insert into `userAccessLog` (user_id,`count`) values (&#x27;&quot;</span>.<span class="variable">$user_id</span>.<span class="string">&quot;&#x27;,1);&quot;</span>;</span><br><span class="line">        <span class="keyword">if</span>(<span class="variable">$connect</span>-&gt;<span class="title function_ invoke__">query</span>(<span class="variable">$sql</span>))&#123;</span><br><span class="line">            <span class="keyword">echo</span> <span class="string">&quot;欢迎您访问xxx&lt;br/&gt;&quot;</span>;</span><br><span class="line">            <span class="keyword">echo</span> <span class="string">&quot;您的访问次数为: 1&quot;</span>.<span class="string">&quot;&lt;br/&gt;&quot;</span>;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">GetRandStr</span>(<span class="params"><span class="variable">$length</span></span>)</span>&#123;</span><br><span class="line">    <span class="comment">//字符组合</span></span><br><span class="line">    <span class="variable">$str</span> = <span class="string">&#x27;abcdefghijklmnopqrstuvwxyzABCDEFGHIJKLMNOPQRSTUVWXYZ0123456789&#x27;</span>;</span><br><span class="line">    <span class="variable">$len</span> = <span class="title function_ invoke__">strlen</span>(<span class="variable">$str</span>)-<span class="number">1</span>;</span><br><span class="line">    <span class="variable">$randstr</span> = <span class="string">&#x27;&#x27;</span>;</span><br><span class="line">    <span class="keyword">for</span> (<span class="variable">$i</span>=<span class="number">0</span>;<span class="variable">$i</span>&lt;<span class="variable">$length</span>;<span class="variable">$i</span>++) &#123;</span><br><span class="line">        <span class="variable">$num</span>=<span class="title function_ invoke__">mt_rand</span>(<span class="number">0</span>,<span class="variable">$len</span>);</span><br><span class="line">        <span class="variable">$randstr</span> .= <span class="variable">$str</span>[<span class="variable">$num</span>];</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> <span class="variable">$randstr</span>;</span><br><span class="line">&#125;</span><br><span class="line"><span class="comment">// payload: user_id=fec699f7473121d0a32960614c2f73f50&#x27; union select 1,version() -- -</span></span><br></pre></td></tr></table></figure>

<p><img src="https://cdn.jsdelivr.net/gh/retry-later/img/2022/image-20220417181209043.png" alt="image-20220417181209043"></p>
<h2 id="HTTP头部注入"><a href="#HTTP头部注入" class="headerlink" title="HTTP头部注入"></a>HTTP头部注入</h2><p>常见的http头部注入参数为：</p>
<figure class="highlight html"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">HTTP_CLIENT_IP</span><br><span class="line">HTTP_X_FORWARDED_FOR,</span><br><span class="line">HTTP_X_FORWARDED,</span><br><span class="line">HTTP_X_CLUSTER_CLIENT_IP,</span><br><span class="line">HTTP_FORWARDED_FOR,</span><br><span class="line">HTTP_FORWARDED,</span><br><span class="line">REMOTE_ADDR</span><br><span class="line">User-agent</span><br><span class="line">Referer</span><br></pre></td></tr></table></figure>

<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">#Http 头部注入Demo</span></span><br><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line"><span class="keyword">include</span> <span class="string">&quot;../conf/db.php&quot;</span>;</span><br><span class="line"><span class="variable">$remoteIP</span> = <span class="string">&quot;&quot;</span>;</span><br><span class="line"><span class="keyword">if</span>(<span class="keyword">isset</span>(<span class="variable">$_SERVER</span>[<span class="string">&#x27;HTTP_X_FORWARDED_FOR&#x27;</span>]))&#123;</span><br><span class="line">    <span class="variable">$remoteIP</span> = <span class="title function_ invoke__">explode</span>(<span class="string">&quot;,&quot;</span>,<span class="variable">$_SERVER</span>[<span class="string">&#x27;HTTP_X_FORWARDED_FOR&#x27;</span>]);</span><br><span class="line">    <span class="variable">$remoteIP</span> = <span class="title function_ invoke__">array_pop</span>(<span class="variable">$remoteIP</span>);</span><br><span class="line">&#125;<span class="keyword">else</span>&#123;</span><br><span class="line">    <span class="variable">$remoteIP</span> = <span class="variable">$_SERVER</span>[<span class="string">&quot;REMOTE_ADDR&quot;</span>];</span><br><span class="line">&#125;</span><br><span class="line"><span class="variable">$sql</span> = <span class="string">&quot;select * from `ipinfo` where city=&#x27;香港&#x27; and &#x27;&quot;</span>.<span class="variable">$remoteIP</span>.<span class="string">&quot;&#x27; between beginNet and endNet;&quot;</span>;</span><br><span class="line"><span class="keyword">echo</span> <span class="variable">$sql</span>.<span class="string">&quot;&lt;br/&gt;&quot;</span>;</span><br><span class="line"><span class="variable">$connect</span> = <span class="keyword">new</span> <span class="title function_ invoke__">mysqli</span>(<span class="variable">$dbHost</span>,<span class="variable">$dbUser</span>,<span class="variable">$dbPassword</span>);</span><br><span class="line"><span class="keyword">if</span>(<span class="variable">$connect</span>-&gt;connect_error)&#123;</span><br><span class="line">    <span class="keyword">die</span>(<span class="string">&quot;数据库连接错误：&quot;</span>).<span class="variable">$connect</span>-&gt;connect_error;</span><br><span class="line">&#125;<span class="keyword">else</span> &#123;</span><br><span class="line">    <span class="variable">$connect</span>-&gt;<span class="title function_ invoke__">select_db</span>(<span class="string">&quot;dvwa&quot;</span>);</span><br><span class="line">    <span class="variable">$result</span> = <span class="variable">$connect</span>-&gt;<span class="title function_ invoke__">query</span>(<span class="variable">$sql</span>);</span><br><span class="line">    <span class="keyword">if</span> (<span class="variable">$result</span>) &#123;</span><br><span class="line">        <span class="keyword">if</span> (<span class="variable">$result</span>-&gt;num_rows &gt; <span class="number">0</span>) &#123;</span><br><span class="line">            <span class="keyword">echo</span> <span class="variable">$remoteIP</span> . <span class="string">&quot;\t查询到您的IP归属地为中国香港,&quot;</span>;</span><br><span class="line">            <span class="keyword">echo</span> <span class="string">&quot;欢迎香港同胞访问本应用。&quot;</span>;</span><br><span class="line">            <span class="variable">$info</span> = <span class="variable">$result</span>-&gt;<span class="title function_ invoke__">fetch_array</span>();</span><br><span class="line">            <span class="keyword">echo</span> <span class="string">&quot;&lt;br/&gt;&quot;</span>;</span><br><span class="line">            <span class="keyword">echo</span> <span class="string">&quot;City:&quot;</span>.<span class="variable">$info</span>[<span class="string">&#x27;city&#x27;</span>];</span><br><span class="line">            <span class="keyword">echo</span> <span class="string">&quot;&lt;br/&gt;&quot;</span>;</span><br><span class="line">            <span class="keyword">echo</span> <span class="string">&quot;ISP:&quot;</span>.<span class="variable">$info</span>[<span class="string">&#x27;ISP&#x27;</span>];</span><br><span class="line">            <span class="keyword">echo</span> <span class="string">&quot;&lt;br/&gt;&quot;</span>;</span><br><span class="line">            <span class="keyword">echo</span> <span class="string">&quot;（数据来源于纯真IP数据库）&quot;</span>;</span><br><span class="line">        &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">            <span class="keyword">echo</span> <span class="variable">$remoteIP</span> . <span class="string">&quot;：\t 查询到您的IP归属地非香港地区，您的访问请求被拒绝；（数据来源于纯真IP数据库）&quot;</span>;</span><br><span class="line">            <span class="keyword">echo</span> <span class="string">&quot;&lt;br/&gt;&quot;</span>;</span><br><span class="line">            <span class="keyword">echo</span> <span class="string">&quot;Error: 本网站仅面向香港同胞。&quot;</span>;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;<span class="keyword">else</span>&#123;</span><br><span class="line">        <span class="keyword">echo</span> <span class="variable">$connect</span>-&gt;error;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"><span class="comment">/* </span></span><br><span class="line"><span class="comment">payload 1 : </span></span><br><span class="line"><span class="comment">1&#x27; union select * from (select 1)a join (select 2)b join (select 3)c join (select 4)d order by 1 limit 1 offset 0  -- -</span></span><br><span class="line"><span class="comment">payload2:</span></span><br><span class="line"><span class="comment">&quot;&#x27; union select * from (select 1)a join (select 2)b join (select 3)c join (select 4)d   -- -</span></span><br><span class="line"><span class="comment">*/</span></span><br></pre></td></tr></table></figure>

<p><img src="https://cdn.jsdelivr.net/gh/retry-later/img/2022/image-20220417181800419.png" alt="image-20220417181800419"></p>
<h2 id="Tips"><a href="#Tips" class="headerlink" title="Tips"></a>Tips</h2><p>因为Demo使用<code>，</code>来获取最后一个xff字段，所以需要对,进行绕过，这里有博主提供了几种不同情况下绕过,的方式。<a target="_blank" rel="noopener" href="https://www.jianshu.com/p/d10785d22db2">https://www.jianshu.com/p/d10785d22db2</a></p>
<h2 id="报错注入"><a href="#报错注入" class="headerlink" title="报错注入"></a>报错注入</h2><p>应用场景在于存在注入点，<em><strong>但是只回显报错信息不展示查询字段</strong></em>，无法将数据通过联合查询带出。</p>
<h3 id="xpath报错注入"><a href="#xpath报错注入" class="headerlink" title="xpath报错注入"></a>xpath报错注入</h3><p>mysql &gt; 5.版本添加了extractvalue函数和updatexml函数以支持对存放在数据库中的xml数据进行查询和修改。两个函数使用xpath定位我们要访问或修改的内容，当我们传入的xpath参数错误时会触发xpath语法错误，并将传入的xpath参数爆出，如果参数为sql语句的话会将语句的执行结果爆出。<a target="_blank" rel="noopener" href="https://dev.mysql.com/doc/refman/5.7/en/xml-functions.html">https://dev.mysql.com/doc/refman/5.7/en/xml-functions.html</a></p>
<ul>
<li>extractvalue() 的正常用法:<code>extractvalue(column/xml字符串，xpath字符串)</code>如：</li>
</ul>
<p><code>SELECT extractValue(&#39;&lt;a href=&quot;sss&quot;&gt;&lt;/a&gt;&lt;a href=&quot;2333&quot;&gt;&lt;/a&gt;&#39;,&#39;/a/attribute::href&#39;);</code></p>
<p><img src="https://cdn.jsdelivr.net/gh/retry-later/img/2022/image-20220419214245859.png" alt="image-20220419214245859"></p>
<p>原义是通过xpath语法对传入的xml字符串进行查询并返回查询结果，如果故意构造错误的xpath语法则会显示：</p>
<p><img src="https://cdn.jsdelivr.net/gh/retry-later/img/2022/image-20220419215231878.png" alt="image-20220419215231878"></p>
<p>从而实现将我们想要的数据带出的目的。</p>
<ul>
<li>updatexml()方法的正常用法为:<code>updatexml(column/xml字符串,xpath字符串,要更新的内容)</code>如：</li>
</ul>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">SET</span> <span class="variable">@xml</span> <span class="operator">=</span> <span class="string">&#x27;&lt;a&gt;111&lt;b:c&gt;222&lt;d&gt;333&lt;/d&gt;&lt;e:f&gt;444&lt;/e:f&gt;&lt;/b:c&gt;&lt;/a&gt;&#x27;</span>;</span><br><span class="line"><span class="keyword">SELECT</span> UpdateXML(<span class="variable">@xml</span>, <span class="string">&#x27;//b:c&#x27;</span>, <span class="string">&#x27;&lt;g:h&gt;555&lt;/g:h&gt;&#x27;</span>);</span><br></pre></td></tr></table></figure>

<p><img src="https://cdn.jsdelivr.net/gh/retry-later/img/2022/image-20220419220208617.png" alt="image-20220419220208617"></p>
<p>和extractvalue函数报错相同，通过构造错误的xpath语句可实现数据的外带。</p>
<p><code>select updatexml(@xml,concat(&quot;~&quot;,hex(user()),&quot;~&quot;),&quot;x&quot;);</code>，构造错误的时候最好使用concat在结果前面加上连接字符，否则可能报错信息所展示的数据不完整。</p>
<p><img src="https://cdn.jsdelivr.net/gh/retry-later/img/2022/image-20220419221950356.png" alt="image-20220419221950356"></p>

        </div>

        
            <section class="post-copyright">
                
                    <p class="copyright-item">
                        <span>Author:</span>
                        <span>pm&fc</span>
                    </p>
                
                
                    <p class="copyright-item">
                        <span>Permalink:</span>
                        <span><a href="https://retry-later.github.io/2022/04/25/%E5%9B%9E%E7%82%89%E9%87%8D%E9%80%A0%E7%B3%BB%E5%88%97-SQL%E6%B3%A8%E5%85%A5/">https://retry-later.github.io/2022/04/25/%E5%9B%9E%E7%82%89%E9%87%8D%E9%80%A0%E7%B3%BB%E5%88%97-SQL%E6%B3%A8%E5%85%A5/</a></span>
                    </p>
                
                
                    <p class="copyright-item">
                        <span>License:</span>
                        <span>Copyright (c) 2019 <a target="_blank" rel="noopener" href="http://creativecommons.org/licenses/by-nc/4.0/">CC-BY-NC-4.0</a> LICENSE</span>
                    </p>
                
                
                     <p class="copyright-item">
                         <span>Slogan:</span>
                         <span>Do you believe in <strong>DESTINY</strong>?</span>
                     </p>
                

            </section>
        
        <section class="post-tags">
            <div>
                <span>Tag(s):</span>
                <span class="tag">
                    
                    
                        <a href="/tags/%E6%B8%97%E9%80%8F%E6%B5%8B%E8%AF%95/"># 渗透测试</a>
                    
                        <a href="/tags/SQL%E6%B3%A8%E5%85%A5/"># SQL注入</a>
                    
                        <a href="/tags/%E7%BD%91%E7%BB%9C%E5%AE%89%E5%85%A8/"># 网络安全</a>
                    
                        
                </span>
            </div>
            <div>
                <a href="javascript:window.history.back();">back</a>
                <span>· </span>
                <a href="/">home</a>
            </div>
        </section>
        <section class="post-nav">
            
            
            <a class="next" rel="next" href="/2022/04/24/C%E8%AF%AD%E8%A8%80-%E6%B5%81%E7%A8%8B%E6%8E%A7%E5%88%B6/">C语言-流程控制</a>
            
        </section>


    </article>
</div>

            </div>
            <footer id="footer" class="footer">
    <div class="copyright">
        <span>© pm&amp;fc | Powered by <a href="https://hexo.io" target="_blank">Hexo</a> & <a href="https://github.com/Siricee/hexo-theme-Chic" target="_blank">Chic</a></span>
    </div>
</footer>

    </div>
</body>

</html>